# Technical plan (Gemini)

This is a comprehensive **Technical Specification** designed to be copy-pasted directly into an AI coding assistant (like Cursor, Windsurf, or ChatGPT). It covers the Database Schema, Theming Logic, Flow Architecture, and Implementation Steps.

To answer your specific questions first:

1. **Linking Pages:** Yes. We will use a **"Slideshow Architecture."** The internal buttons of the component (e.g., "Submit") won't actually navigate. Instead, the Parent App (Flow Viewer) controls the navigation. You "link" them by defining their order in the database.
2. **Theming:** Yes. We will implement a postMessage system where the Parent App reads the URL (?theme=dark) and tells the Iframe to toggle the dark class on the <html> tag.

Here is the plan for your LLM.

# **Technical Specification: FlowState MVP**

## **1. Project Overview**

**FlowState** is a web application that catalogs and renders interactive UI components (Pages) and multi-step user journeys (Flows) reverse-engineered from popular apps.

- **Core Function:** Store React component code as strings in a database and render them safely via a sandboxed Iframe.
- **Tech Stack:** Vite (React), Supabase (Database + Auth), Tailwind CSS (via CDN in Iframe).
- **Key Requirement:** Support query-param based theming (?theme=dark) and future-proof data modeling for linking pages into flows.

## **2. Database Schema (Supabase / PostgreSQL)**

We will use a relational model. "Components" are atomic screens. "Flows" are ordered collections of Components.

```sql
-- 1. The Atomic Unit: A Single Screen/Page
create table components (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  name text not null,                -- e.g., "Uber Login Screen"
  description text,
  code_string text not null,         -- The raw React component code
  tags text[],                       -- e.g., ['auth', 'mobile', 'dark-mode']
  original_app text,                 -- e.g., "Uber"
  viewport_width text default '375px' -- Default mobile width
);

-- 2. The Container: A User Journey
create table flows (
  id bigint generated by default as identity primary key,
  name text not null,                -- e.g., "Uber Driver Onboarding"
  description text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. The Link: Connecting Flows to Components
create table flow_steps (
  id bigint generated by default as identity primary key,
  flow_id bigint references flows(id) on delete cascade,
  component_id bigint references components(id) on delete cascade,
  step_order int not null,           -- 1, 2, 3 (Defines the sequence)
  unique(flow_id, step_order)        -- Prevent duplicate steps at same index
);
```

## **3. Architecture: The Rendering Engine**

We will not render user code directly in the main DOM. We will use a **Smart Iframe**.

### **A. The public/preview.html (The Sandbox)**

This static file lives in the public folder. It acts as the "Player."

**Key Logic:**

1. **Tailwind CDN:** Loaded instantly.
2. **Theme Listener:** Checks URL params OR listens for messages to toggle <html class="dark">.
3. **Code Executor:** Receives code string $\rightarrow$ Transpiles (optional) $\rightarrow$ Renders.

### **B. The PreviewFrame.jsx (The Controller)**

A React component in the main app that wraps the iframe.

**Responsibility:**

1. Accepts code (string) and theme (string) as props.
2. Passes data into the Iframe via postMessage.
3. Handles resizing (Mobile/Desktop view).

## **4. Feature Logic: Theming & Flows**

### **Feature: Theming (?theme=dark)**

- **Mechanism:** The Main App checks the URL useSearchParams.
- **Propogation:**
- Main App detects ?theme=dark.
- Main App sends { type: 'THEME_CHANGE', mode: 'dark' } to Iframe.
- Iframe script: document.documentElement.classList.add('dark').
- **Tailwind Config:** The CDN script automatically uses the class strategy.

### **Feature: Flows (The "Slideshow")**

- **Route:** /flow/:id (e.g., /flow/50)
- **Logic:**

1. Fetch flow_steps for ID 50, ordered by step_order.
2. Store in array: [Step1, Step2, Step3].
3. State: currentStepIndex (0).
4. Render: <PreviewFrame code={steps[currentStepIndex].code_string} />.
5. **Navigation:**

- The **Internal Component** (Step 1) is visual only. Clicking "Next" inside the component does nothing (event validation prevented).
- The **External UI** (a floating footer) has "Next / Previous" buttons that update currentStepIndex.

## **5. File Structure Implementation Plan**

```
/src
  /components
    /renderer
      PreviewFrame.jsx      # The Iframe wrapper
      DeviceMockup.jsx      # Phone/Browser border styling
    /flow
      FlowControls.jsx      # Next/Prev buttons
      FlowList.jsx          # Grid of flows
    /layout
      Sidebar.jsx           # App navigation
  /pages
    Library.jsx             # Browse all components
    ComponentDetail.jsx     # View single component
    FlowPlayer.jsx          # View a Flow (The Slideshow)
  /lib
    supabase.js             # DB Client
```

## **6. Step-by-Step Instructions for the AI (Copy this)**

Instruction to AI:

"You are building 'FlowState', a component library app using Vite, React, and Supabase. Follow these exact implementation steps:"

**Step 1: Setup & Database**

- Initialize a Vite React app.
- Install @supabase/supabase-js, react-router-dom, lucide-react.
- Create the components, flows, and flow_steps tables (schema provided above) in Supabase.
- Add dummy data: Create 2 components (e.g., 'Login', 'Success') and 1 Flow that links them.

**Step 2: The Iframe Renderer**

- Create public/preview.html. Add the Tailwind script <script src="https://cdn.tailwindcss.com"></script>.
- Add a script block in preview.html that listens for window.addEventListener('message'). It should look for a code payload and a theme payload.
- For the code execution, use a safe evaluation method (or new Function) to render the React component string into root.

**Step 3: The Preview Component**

- Build src/components/renderer/PreviewFrame.jsx.
- It should render an <iframe src="/preview.html" />.
- Use useEffect to post the codeString to the iframe whenever it changes.
- Implement a check for the theme prop. If theme='dark', post a message to add the dark class to the iframe HTML.

**Step 4: The Flow Player**

- Create src/pages/FlowPlayer.jsx.
- Fetch the flow steps from Supabase based on the URL ID.
- Implement useState for the current step index.
- Render the PreviewFrame passing the code of the _current_ step.
- Add "Next" and "Previous" buttons outside the iframe to control the index.

**Step 5: Theming Support**

- In App.jsx, use useSearchParams to detect ?theme=dark.
- Pass this value down to the PreviewFrame so the component renders in the correct mode.

### **Refined User Experience for "Linking"**

When you are ready to "Link" pages, you won't write code. You will build a simple **Admin UI** (later):

1. Dropdown: "Select Flow" (e.g., Uber Signup).
2. Dropdown: "Add Component" (e.g., Step 1: Email).
3. Button: "Add Step".

This populates the flow_steps table. Your frontend automatically renders this as a connected journey.
